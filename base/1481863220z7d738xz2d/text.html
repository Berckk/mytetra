<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; font-weight:600; color:#333333;">В продолжение публикации «Транзитивное замыкание запросом» [</span><a href="http://infostart.ru/public/158512/"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; font-weight:600; text-decoration: underline; color:#428bca;">http://infostart.ru/public/158512/</span></a><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; font-weight:600; color:#333333;">] добавлены другие варианты использования того же приема. Приведены запросы для быстрого определения уровней всех элементов справочника, максимальной глубины справочника, прародителей произвольных элементов справочника, запрос для быстрого определения циклов (на примере справочника спецификаций «1С:Управление производственным предприятием») и определения множеств аналогов номенклатуры (также на примере конфигурации «1С:Управление производственным предприятием»).</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333;">В предыдущей статье был рассмотрен прием «матричного умножения» в расчете транзитивного замыкания отношений, его теоретическое обоснование и реализация на платформе «1С:Предприятие 8» на примере замыкания иерархии справочника. Из-за того, что данный прием хорошо ложится на возможности конструирования текста запроса на языке 1С, получаемый с использованием этого приема код оказывается очень компактным (всего 9 строк!) и быстрым. Возможно, у кого-то могло сложиться впечатление, что решением одной экзотической задачи с непонятным названием область применения рассмотренного метода и ограничивается. Однако, ЭТО НЕ ТАК! Существуют более приземленные практические задачи, где с большой выгодой можно применить разработанный прием построения запроса. В данной статье рассмотрены сразу пять таких задач.</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'inherit,serif'; font-size:14.5pt; color:#333333;">1. Быстрое определение уровней всех элементов справочника одним пакетным запросом.</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333;">При использовании объектной модели для получения уровня элемента иерархического справочника можно использовать функцию «Уровень». Она показывает уровень вложенности текущего элемента справочника, при этом элементы в корне иерархии, вообще не имеющие родителей, имеют уровень «0».</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333;">У этой функции два недостатка. Во-первых, она медленно выполняется. Почему это так, понять несложно, если вспомнить, как хранится иерархия в таблицах СУБД. Во-вторых, функция «Уровень» не работает в запросе. А этого как раз очень часто и не хватает: наличие колонки, содержащей уровень иерархии элемента, упростило бы решение многих задач запросами.</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333;">Выходом может быть использование следующего запроса и построенной на нем функции</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">Функция </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">УровниИерархии</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">ИмяСправочника</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаПути</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">) Экспорт</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;"><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Пролог </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;ВЫБРАТЬ Родитель НачалоДуги, Ссылка КонецДуги ПОМЕСТИТЬ ЗамыканияДлины1 ИЗ Справочник.Номенклатура<br />            | ГДЕ Родитель &lt;&gt; Значение(Справочник.Номенклатура.ПустаяСсылка)<br />            | ОБЪЕДИНИТЬ ВЫБРАТЬ Ссылка, Ссылка ИЗ Справочник.Номенклатура;&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;"><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Рефрен </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;ВЫБРАТЬ РАЗЛИЧНЫЕ ПерваяДуга.НачалоДуги, ВтораяДуга.КонецДуги ПОМЕСТИТЬ ЗамыканияДлины#2 ИЗ ЗамыканияДлины#1 КАК ПерваяДуга<br />            | СОЕДИНЕНИЕ ЗамыканияДлины#1 КАК ВтораяДуга ПО ПерваяДуга.КонецДуги = ВтораяДуга.НачалоДуги;<br />            | УНИЧТОЖИТЬ ЗамыканияДлины#1;&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;"><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Эпилог </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;ВЫБРАТЬ КОЛИЧЕСТВО(НачалоДуги) - 1 Предок, КонецДуги Потомок ИЗ ЗамыканияДлины#2 СГРУППИРОВАТЬ ПО КонецДуги&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">;<br /><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= Новый </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">СтрЗаменить</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Пролог</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;Номенклатура&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">ИмяСправочника</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">));<br /><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">1</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">;<br /><br />    Пока </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">&lt; </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаПути </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">Цикл<br /><br />        </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">.</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Текст </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">.</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Текст </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">+ </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">СтрЗаменить</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">СтрЗаменить</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Рефрен</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;#1&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">,</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Формат</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;ЧГ=0&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">)), </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;#2&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Формат</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">2 </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">* </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;ЧГ=0&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">));<br /><br />        </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">2 </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">* </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий<br /><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">КонецЦикла;<br /><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">.</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Текст </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">.</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Текст </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">+ </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">СтрЗаменить</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Эпилог</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;#2&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Формат</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">,</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;ЧГ=0&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">));<br /><br />    Возврат </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">.</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Выполнить</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">().</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Выгрузить</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">()<br /><br />КонецФункции</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333;">Запрос в данной функции отличается от базового запроса из основной статьи только эпилогом. Работа функции построена на следующем наблюдении: так как таблица транзитивного замыкания содержит всех предков любого элемента, то, чтобы определить его уровень, нужно просто посчитать этих предков.</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333; background-color:#ffff00;">Разумеется, сконструированный внутри функции текст запроса не обязательно сразу выполнять. Его можно сделать частью более общего пакетного запроса, в котором будет использоваться получаемая на последнем этапе таблица. Это касается и всех следующих примеров.</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333;">Рассмотрим, для примера, следующую иерархию номенклатуры:</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><img src="image263.png" /><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333;">Замыкание иерархии вернет следующую таблицу:</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><img src="image9127.png" /><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333;">Приведенная функция на основе подсчета предков в замыкании вернет следующую таблицу:</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><img src="image4800.png" /><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'inherit,serif'; font-size:14.5pt; color:#333333;">2. Быстрое определение максимальной глубины иерархии одним пакетным запросом.</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333;">Данная задача может возникнуть, например, при выводе иерархических списков, когда требуется заранее определить  «высоту» (число этажей) отображения списка. Трудность задачи в том, что приходится просматривать все элементы справочника, для каждого из которых необходим вызов  функции «Уровень». Хотя такой код весьма прост,</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">Функция </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальныйУровеньСправочника</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">ИмяСправочника</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Ответ </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">0</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">) Экспорт</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;"><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Выборка </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Справочники</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">[</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">ИмяСправочника</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">].</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Выбрать</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">();<br /><br />    Пока </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Выборка</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">.</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Следующий</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">() Цикл </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Ответ </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Макс</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Ответ</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Выборка</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">.</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">ПолучитьОбъект</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">().</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Уровень</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">())<br />    КонецЦикла;<br /><br />    Возврат </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Ответ<br /><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">КонецФункции</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333;">время его выполнения сильно и неприятно удивляет. В прилагаемой к статье обработке есть кнопка «Ой, глубина», которая вызывает написанную таким образом функцию и позволяет убедиться в большом времени ее работы. Конечно, можно использовать рекурсию, загрузив весь справочник в оперативную память, однако на больших справочниках применение рекурсии также будет не столь эффективным из-за большого количества отдельных вычислений. Пример использования рекурсии приведен здесь [</span><a href="http://infostart.ru/redirect.php?url=aHR0cDovL25hc2hlMWMucnUvbWF0ZXJpYWxzLXZpZXcuanNwP2lkPTM3MQ=="><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; text-decoration: underline; color:#428bca;">http://nashe1c.ru/materials-view.jsp?id=371</span></a><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333;">]. Решение не  образцовое,  однако доказывает интерес к данной теме.</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333;">В результате, наилучшим решением оказывается использование предлагаемого запроса в следующем виде:</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">Функция </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">ГлубинаИерархии</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">ИмяСправочника</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаПути</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">) Экспорт</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;"><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Пролог </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;ВЫБРАТЬ Родитель НачалоДуги, Ссылка КонецДуги ПОМЕСТИТЬ ЗамыканияДлины1 ИЗ Справочник.Номенклатура<br />            | ГДЕ Родитель &lt;&gt; Значение(Справочник.Номенклатура.ПустаяСсылка)<br />            | ОБЪЕДИНИТЬ ВЫБРАТЬ Ссылка, Ссылка ИЗ Справочник.Номенклатура;&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;"><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Рефрен </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;ВЫБРАТЬ РАЗЛИЧНЫЕ ПерваяДуга.НачалоДуги, ВтораяДуга.КонецДуги ПОМЕСТИТЬ ЗамыканияДлины#2 ИЗ ЗамыканияДлины#1 КАК ПерваяДуга<br />            | СОЕДИНЕНИЕ ЗамыканияДлины#1 КАК ВтораяДуга ПО ПерваяДуга.КонецДуги = ВтораяДуга.НачалоДуги;<br />            | УНИЧТОЖИТЬ ЗамыканияДлины#1;&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;"><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Эпилог </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;ВЫБРАТЬ ПЕРВЫЕ 1 КОЛИЧЕСТВО(НачалоДуги) - 1 Глубина, КонецДуги Потомок ИЗ ЗамыканияДлины#2 СГРУППИРОВАТЬ ПО КонецДуги УПОРЯДОЧИТЬ ПО КОЛИЧЕСТВО(НачалоДуги) - 1 УБЫВ&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">;<br /><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= Новый </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">СтрЗаменить</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Пролог</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;Номенклатура&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">ИмяСправочника</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">));<br /><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">1</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">;<br /><br />    Пока </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">&lt; </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаПути </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">Цикл<br /><br />        </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">.</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Текст </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">.</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Текст </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">+ </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">СтрЗаменить</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">СтрЗаменить</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Рефрен</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;#1&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">,</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Формат</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;ЧГ=0&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">)), </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;#2&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Формат</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">2 </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">* </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;ЧГ=0&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">));<br /><br />        </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">2 </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">* </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий<br /><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">КонецЦикла;<br /><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">.</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Текст </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">.</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Текст </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">+ </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">СтрЗаменить</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Эпилог</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;#2&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Формат</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">,</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;ЧГ=0&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">));<br /><br />    Возврат </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">.</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Выполнить</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">().</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Выгрузить</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">()[0].Глубина<br /><br />КонецФункции</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333;">Для краткости, случай, когда в справочнике нет ни одного элемента, не рассматривается.</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333;">Для того же примера глубина будет равна 3</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><img src="image24381.png" /><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333;"><br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'inherit,serif'; font-size:14.5pt; color:#333333;">3. Определение прародителя (родителя верхнего уровня) в пакетном запросе.</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333;">Судя по обсуждениям на форумах, этот вопрос встречается достаточно часто. Широко известно решение, использующее итоги по иерархии [в комментарии (6) к предыдущей статье]. Однако оно не подходит для того, чтобы использоваться в середине пакетного запроса, не дает простой возможности одновременного определения родителей верхнего уровня нескольких элементов и, вероятно, не работает максимально быстро. От этих недостатков свободно следующее решение</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">Функция </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Прародители</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">ИмяСправочника</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаПути</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">) Экспорт</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;"><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Пролог </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;ВЫБРАТЬ Родитель НачалоДуги, Ссылка КонецДуги ПОМЕСТИТЬ ЗамыканияДлины1 ИЗ Справочник.Номенклатура<br />            | ГДЕ Родитель &lt;&gt; Значение(Справочник.Номенклатура.ПустаяСсылка)<br />            | ОБЪЕДИНИТЬ ВЫБРАТЬ Ссылка, Ссылка ИЗ Справочник.Номенклатура;&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;"><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Рефрен </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;ВЫБРАТЬ РАЗЛИЧНЫЕ ПерваяДуга.НачалоДуги, ВтораяДуга.КонецДуги ПОМЕСТИТЬ ЗамыканияДлины#2 ИЗ ЗамыканияДлины#1 КАК ПерваяДуга<br />            | СОЕДИНЕНИЕ ЗамыканияДлины#1 КАК ВтораяДуга ПО ПерваяДуга.КонецДуги = ВтораяДуга.НачалоДуги;<br />            | УНИЧТОЖИТЬ ЗамыканияДлины#1;&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;"><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Эпилог </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;ВЫБРАТЬ НачалоДуги Предок, КонецДуги Потомок ИЗ ЗамыканияДлины#2<br />            | ГДЕ НачалоДуги &lt;&gt; КонецДуги И НачалоДуги.Родитель = Значение(Справочник.Номенклатура.ПустаяСсылка)&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;"><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= Новый </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">СтрЗаменить</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Пролог</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;Номенклатура&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">ИмяСправочника</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">));<br /><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">1</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">;<br /><br />    Пока </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">&lt; </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаПути </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">Цикл<br /><br />        </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">.</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Текст </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">.</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Текст </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">+ </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">СтрЗаменить</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">СтрЗаменить</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Рефрен</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;#1&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">,</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Формат</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;ЧГ=0&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">)), </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;#2&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Формат</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">2 </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">* </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;ЧГ=0&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">));<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">        </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">2 </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">* </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;"><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">КонецЦикла;<br /><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">.</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Текст </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">.</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Текст </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">+ </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">СтрЗаменить</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Эпилог</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;#2&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Формат</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">,</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;ЧГ=0&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">));<br /><br />    Возврат </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">.</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Выполнить</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">().</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Выгрузить</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">()<br /><br />КонецФункции</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">Для того же примера...</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><img src="image4188.png" /><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'inherit,serif'; font-size:14.5pt; color:#333333;"> </span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'inherit,serif'; font-size:14.5pt; color:#333333;">4. Быстрое определение циклов произвольной длины одним пакетным запросом.</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333;">Определение циклов основано на следующей идее:</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333;">Будем считать уровнем элемента количество прямо или косвенно «предшествующих» ему других элементов (в смысле конкретного отношения). Такой уровень на основе таблицы транзитивного замыкания легко посчитать для ориентированного графа любого вида. Нетрудно догадаться, что уровень всех элементов, находящихся в цикле, будет одинаков. Тогда признаком того, что дуга принадлежит циклу, будет одинаковый уровень ее концов.</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333;">В результате получаем следующий запрос, находящий дуги, принадлежащие циклу.</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">Функция </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">ЦиклыСпецификацийУПП</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаПути</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">) Экспорт</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;"><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Пролог </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;ВЫБРАТЬ Выход.Номенклатура НачалоДуги, Вход.Номенклатура КонецДуги, Выход.Ссылка ПОМЕСТИТЬ ИсходноеОтношение<br />            | ИЗ Справочник.СпецификацииНоменклатуры.ВыходныеИзделия КАК Выход<br />            | СОЕДИНЕНИЕ Справочник.СпецификацииНоменклатуры.ИсходныеКомплектующие КАК Вход ПО Выход.Ссылка = Вход.Ссылка<br />            | ГДЕ Выход.Ссылка.Активная;<br />            | ВЫБРАТЬ РАЗЛИЧНЫЕ НачалоДуги, КонецДуги ПОМЕСТИТЬ ЗамыканияДлины1 ИЗ ИсходноеОтношение<br />            | ОБЪЕДИНИТЬ ВЫБРАТЬ НачалоДуги, НачалоДуги ИЗ ИсходноеОтношение<br />            | ОБЪЕДИНИТЬ ВЫБРАТЬ КонецДуги, КонецДуги ИЗ ИсходноеОтношение;&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;"><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Рефрен </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;ВЫБРАТЬ РАЗЛИЧНЫЕ ПерваяДуга.НачалоДуги, ВтораяДуга.КонецДуги ПОМЕСТИТЬ ЗамыканияДлины#2 ИЗ ЗамыканияДлины#1 КАК ПерваяДуга<br />            | СОЕДИНЕНИЕ ЗамыканияДлины#1 КАК ВтораяДуга ПО ПерваяДуга.КонецДуги = ВтораяДуга.НачалоДуги;<br />            | УНИЧТОЖИТЬ ЗамыканияДлины#1;&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;"><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Эпилог </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;ВЫБРАТЬ КОЛИЧЕСТВО(НачалоДуги) Уровень, КонецДуги Элемент ПОМЕСТИТЬ ТаблицаУровней ИЗ ЗамыканияДлины#2 СГРУППИРОВАТЬ ПО КонецДуги;<br />            | ВЫБРАТЬ ИсходноеОтношение.НачалоДуги Предок, ИсходноеОтношение.КонецДуги Потомок, ИсходноеОтношение.Ссылка Спецификация ИЗ ИсходноеОтношение<br />            | СОЕДИНЕНИЕ ТаблицаУровней КАК Начало ПО ИсходноеОтношение.НачалоДуги = Начало.Элемент<br />            | СОЕДИНЕНИЕ ТаблицаУровней КАК Конец ПО ИсходноеОтношение.КонецДуги = Конец.Элемент<br />            | ГДЕ Начало.Уровень = Конец.Уровень&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;"><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= Новый </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Пролог</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">);<br /><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">1</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">;<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">    Пока </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">&lt; </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаПути </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">Цикл<br /><br />        </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">.</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Текст </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">.</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Текст </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">+ </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">СтрЗаменить</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">СтрЗаменить</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Рефрен</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;#1&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">,</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Формат</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;ЧГ=0&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">)), </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;#2&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Формат</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">2 </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">* </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;ЧГ=0&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">));<br /><br />        </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">2 </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">* </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий<br /><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">КонецЦикла;<br /><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">.</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Текст </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">.</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Текст </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">+ </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">СтрЗаменить</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Эпилог</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;#2&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Формат</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">,</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;ЧГ=0&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">));<br /><br />    Возврат </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">.</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Выполнить</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">().</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Выгрузить</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">()<br /><br />КонецФункции</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333;">Запрос приведен на примере проверки зацикливания спецификаций продукции для типовой конфигурации «1С: Управление производственным предприятием». Приведенная функция выдает список связей входов и выходов спецификаций, находящихся в цикле вместе с указанием самих спецификаций. Очевидно, что ошибочной (приводящей к зацикливанию) будет, вероятнее всего, только одна из указанных связей. Можно не ограничиваться только сборочными спецификациями. Но следует учесть, что в этом общем случае могут существовать и правильные циклы сборки-разборки, которые запрос также будет показывать.</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333;">Понятно, что такой подход будет обнаруживать циклы любой длины. Безошибочно ограничивать максимальную длину пути можно количеством активных спецификаций, как и сделано в прилагаемой обработке.</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333;">Для примера приведен набор спецификаций, содержащий циклы. Это спецификация структуры всем известной детской песни &quot;Вместе весело шагать&quot;</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><img src="image19816.png" /><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333;">&quot;Песенка&quot; получается по двум спецификациям: С1(Словечко1 + Словечко2) и С2(Куплет1 + Куплет2 + Куплет3).</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333;">Функция, обнаруживающая циклы, вернет следующую таблицу</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><img src="image10359.png" /><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'inherit,serif'; font-size:14.5pt; color:#333333;"> </span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'inherit,serif'; font-size:14.5pt; color:#333333;">5. Определение множества взаимозаменяемых позиций (аналогов) номенклатуры.</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333;">Существует несколько решений для хранения информации о взаимозаменяемости номенклатурных позиций [</span><a href="http://infostart.ru/public/128065/"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; text-decoration: underline; color:#428bca;">http://infostart.ru/public/128065/</span></a><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333;">]. Например, в УПП для этого используется регистр сведений «АналогиНоменклатуры», в записях которого указывается собственно номенклатура и заменяющий ее аналог (назначение других полей этих записей для данного обсуждения не существенно). Чаще всего можно считать, что если для детали “А” аналогом является деталь “Б”, то верно и обратное: для детали “Б” аналогом будет деталь “А”. Кроме того, если деталь “Б” является аналогом детали “А”, а деталь “В” является аналогом детали “Б”, то деталь “В” также будет аналогом детали “А”.</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333;">Как же следует задавать аналоги: по цепочке “А”-&gt;”Б”, ”Б”-&gt;”В” или звездой “А”-&gt;“Б”, ”А”-&gt;“В”? - Предлагаемый метод позволяет не задумываться об этом. В любом случае будут найдены все аналоги каждой номенклатуры. Для этого используется функция</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">Функция </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">ТранзитивноеЗамыканиеАналогии</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаПути</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">) Экспорт</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;"><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Пролог </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;ВЫБРАТЬ Номенклатура КАК НачалоДуги, Аналог КАК КонецДуги ПОМЕСТИТЬ ЗамыканияДлины1 ИЗ РегистрСведений.АналогиНоменклатуры<br />            | ОБЪЕДИНИТЬ ВСЕ ВЫБРАТЬ Аналог, Номенклатура ИЗ РегистрСведений.АналогиНоменклатуры<br />            | ОБЪЕДИНИТЬ ВСЕ ВЫБРАТЬ Номенклатура, Номенклатура ИЗ РегистрСведений.АналогиНоменклатуры;&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;"><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Рефрен </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;ВЫБРАТЬ РАЗЛИЧНЫЕ ПерваяДуга.НачалоДуги, ВтораяДуга.КонецДуги ПОМЕСТИТЬ ЗамыканияДлины#2 ИЗ ЗамыканияДлины#1 КАК ПерваяДуга<br />            | ВНУТРЕННЕЕ СОЕДИНЕНИЕ ЗамыканияДлины#1 КАК ВтораяДуга ПО ПерваяДуга.КонецДуги = ВтораяДуга.НачалоДуги;<br />            | УНИЧТОЖИТЬ ЗамыканияДлины#1;&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;"><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Эпилог </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;ВЫБРАТЬ НачалоДуги Предок, КонецДуги Потомок ИЗ ЗамыканияДлины#2 ГДЕ НачалоДуги &lt;&gt; КонецДуги&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">;<br /><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= Новый </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Пролог</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">);<br /><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">1</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">;<br /><br />    Пока </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">&lt; </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаПути </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">Цикл<br /><br />        </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">.</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Текст </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">.</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Текст </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">+ </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">СтрЗаменить</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">СтрЗаменить</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Рефрен</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;#1&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">,</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Формат</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;ЧГ=0&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">)), </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;#2&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Формат</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">2 </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">* </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;ЧГ=0&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">));<br /><br />        </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">2 </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">* </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий<br /><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">КонецЦикла;<br /><br />    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">.</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Текст </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">= </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">.</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Текст </span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">+ </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">СтрЗаменить</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Эпилог</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;#2&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Формат</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">(</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">МаксимальнаяДлинаЗамыканий</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">,</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">&quot;ЧГ=0&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">));<br /><br />    Возврат </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Запрос</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">.</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Выполнить</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">().</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">Выгрузить</span><span style=" font-family:'Courier New'; font-size:10pt; color:#ff0000;">()<br /><br />КонецФункции</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333;">Используя данный запрос, можно существенно сэкономить на хранении информации об аналогах. То есть, вместо указания для каждой номенклатуры всех ее аналогов, можно указать основную позицию и ее заменители «звездой», либо задать аналоги по цепочке, либо пользуясь комбинацией этих подходов – в виде дерева. В результате будет храниться только «остов» отношения аналогии. Например, если в группе взаимозаменяемости 100 деталей, то по максимуму потребуется ввести 100х99 = 9900 записей типа номенклатура-аналог, а в случае хранения только основных записей потребуется хранить всего 99 записей!</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333;">На следующем рисунке приведены примеры аналогов. Красным обозначены связи, которые не хранятся в БД.</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><img src="image5734.png" /><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333;">В УПП понадобится 5 записей регистра сведений &quot;Аналоги номенклатуры&quot; для этих связей.</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><img src="image28216.png" /><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333;">После транзитивного замыкания аналогии будет сформирована полная таблица аналогов</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><img src="image25876.png" /><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333;"> </span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333;">Из-за фундаментального характера затрагиваемых понятий приведенные примеры, скорее всего, не исчерпывают всего списка применений предложенного приема. Надеюсь, приведенные решения являются достаточно поучительными и послужат хорошей основой для решения и других  подобных практических задач.  </span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:10pt; color:#333333;">Еще двум интереснейшим задачам-примерам будет посвящена отдельная статья.</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">  </span></p></body></html>