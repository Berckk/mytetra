<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'Consolas'; font-size:12pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В один прекрасный день надоедает нажимать Shift, чтобы вывелся символ <span style=" font-weight:600;">~</span> вместо <span style=" font-weight:600;">`</span>.<br />Надоедает тянуться до Esc, при этом клавишей CapsLock пользуетесь РЕДКО.<br />Надоедает смещать кисть вниз и нажимать его слабым мизинчиком, либо, не дай бог, тянуться до него большим пальцем.<br />Надоедает лезть за PgUp, PgDn, Home и End, двигая руку каждый раз, чтобы всего лишь промотать страницу вниз.<br />Надоедает каждый раз, когда вы делаете опечатку, со злобой смотреть на клавиатуру в поисках кнопки Backspace.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Сегодня мы узнаем, как навсегда избавиться от этих мучений.<br /><br /></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:large; font-weight:600;">Зачем это всё?</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Чтобы меньше нажимать клавиши. Чтобы меньше тянуться пальцами до тех клавиш, которые часто нажимаем. Чтобы руки меньше уставали. Чтобы легче запоминать что где. Чтобы быстрее печатать, в конце концов.<br /><br />Многие раскладки для печати (Dvorak, Colemak и т.п.) сильно улучшают расположение клавиш, ставя их ближе к тем местам, куда нужно меньше тянуться. Но при этом совершенно забывают о модификаторах, спец. символах и командных клавишах (Enter, Backspace, Tab, Esc, Delete). А мы подумаем о том, как улучшить существующее положение вещей.<br /><br />В статье пойдём от простейших изменений, до более интересной и глубокой настройки. И, как в конце хороших фильмов, я оставлю читателя подумать, что делать дальше, и не дам готового рецепта на всё. В конце концов, идеальных и универсальных решений нет, и на раскладку клавиатур товарищей нет.<br /><a name="habracut"></a><br /></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:large; font-weight:600;">Первые шаги калеки</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Стандартную раскладку нужно модифицировать под себя. Сделать это можно многими способами. Не думаю, что кто-то здесь пользуется экзотическими ibus, Fcitx, SCIM или UIM, поэтому предположу, что у всех работает стандартный X Keyboard extension, XKB. Стоит заметить, что в грядущем на десктопе Wayland, XKB, скорее всего останется отвечать за клавиатуру, также как и в Xorg. Если вдруг тут есть смельчаки, которые уже работают с XWayland, поделитесь своими впечатлениями, работает ли описанное мной у вас. Про альтернативный Wayland Mir от Canonical ничего сказать не могу, кроме того, что вряд ли они возьмутся переписывать и подсистему взаимодействия с клавиатурой.<br /><br />Первое, что приходит в голову — воспользоваться какими-то графическими утилитами. Если честно, то этот этап я пропустил, и сразу воспользовался xmodmap. Чуть ниже я расскажу, что не так с этим подходом и как делать правильно.<br /><br />Xmodmap позволяет, например, поменять слоями <span style=" font-weight:600;">; </span>и <span style=" font-weight:600;">:</span>, особенно это полезно тем, кто программирует на современном языке, который уже не требует обязательной точки с запятой в конце строки. Даже в JavaScript этого уже делать не нужно. И помогает вот такая простая команда:<br /></p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">$ xmodmap -e &quot;keycode 47 = colon semicolon Cyrillic_zhe Cyrillic_ZHE&quot;</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Запускать её нужно из .xsession или .xinitrc. Последние два аргумента в кавычках помогут не потерять при обмене буквы <span style=" font-weight:600;">ж</span> и <span style=" font-weight:600;">Ж</span>.<br /><br />А вот такая, например, поменяет местами <span style=" font-weight:600;">~</span> и <span style=" font-weight:600;">`</span>:<br /></p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">$ xmodmap -e &quot;keycode 49 = asciitilde grave Cyrillic_io Cyrillic_IO&quot;</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:large; font-weight:600;">Переключение раскладки</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Часто ли вам приходится пользоваться Alt? Если вдруг нет, а мне, я заметил, приходится это делать только в богатых менюшками интерфейсах, типа Gimp или LibreOffice, то его можно использовать в качестве переключателя правый Alt, известный как AltGr:<br /></p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">$ setxkbmap -layout us,ru -option grp:toggle</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:large; font-weight:600;">Esc vs CapsLock</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Многие, кто часто пользуются Vim, или используют vi сочетания в консоли, и кто мало ругается на форумах, предпочитают иметь Escape на клавише CapsLock:<br /></p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';"> $ xmodmap -e &quot;clear lock&quot;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';"> $ xmodmap -e &quot;keycode 0x42 = Escape&quot;</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />То же самое можно сделать ещё немного проще:<br /></p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">  setxkbmap -option caps:escape</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Или даже вот так, сохраняя CapsLock на месте старого Escape на случай переписки на повышенных тонах:<br /></p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">  setxkbmap -option caps:swapescape</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Откуда эти загадочные параметры, мы с вами узнаем чуть позже.<br /><br /></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:large; font-weight:600;">Цветочки</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Наверное, удивлю вас, если скажу, что то, что мы делали до этого было не совсем правильно. setxkbmap ещё ничего, а вот xmodmap появился ещё до XKB, и живёт только для совместимости. Мало того, он ничего не знает и о половине клавиш, синтаксис и принцип работы у него более, чем загадочен, он переводит keycode и keysym, а в некоторых случаях и обратно. Разбираться в этом нет никакого смысла, потому что он в какой-то момент отомрёт, и все ваши ухищрения нужно будет повторять, только уже с помощью другой утилиты, а вы расстроитесь и назло всем опять станете печатать двумя указательными пальцами.<br /><br />Так вот, всё это работает до одного прекрасного момента, пока не начинаешь понимать, что нужных клавиш много, а пальцы, которые лежат на домашней строке (ASDF JKL;) до всех не дотягиваются.<br />Я, например, часто пользуюсь клавишей с обозначением Win, которая является модификатором Mod4. Расположена она на моей клавиатуре не слишком удобно, а именно между левыми Alt и Ctrl.<br /><br /></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:large; font-weight:600;">Правильный способ</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Правильно всё это делать с помощью xkbcomp. Название у утилиты, как и man к ней дают мало информации о том, чем она занимается. Якобы переводит текстовые описания раскладки клавиатуры в бинарный формат. А на самом деле ещё и загружает их. Давайте попробуем, чтобы понять, как сделать то, что мы уже сделали, только с её помощью.<br /><br />Запомните, многие в интернете советуют модифицировать файлы, лежащие в /usr/share/X11/xkb/symbols, а именно us, pc и ru. Не делайте этого. Это файлы, действующие на всю систему сразу. На других пользователей (если вдруг у вас такие есть), и если вы там с чем-то накосячите, то набирать текст, даже логин и пароль, бкдшт труднее. Не стоит даже класть туда и модифицированные файлы, и ничего не нужно прописывать в evdev.xml.<br /><br /><span style=" font-weight:600;">Важно:</span> если вы вдруг сделаете что-то не так, то перезагрузка X'ов вам поможет. Есть и более простой способ, можно запустить команду setxkbmap без параметров, и она сбросит почти все ваши настройки на раскладку по умолчанию.<br /><br />Первым делом нам нужно узнать текущие настройки раскладки, сделать это нужно до всех манипуляций:<br /></p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">$ setxkbmap -layout us,ru -print</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />На выходе получим что-то вроде этого:<br /></p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">xkb_keymap {</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">  xkb_keycodes  { include &quot;evdev+aliases(qwerty)&quot; };</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">  xkb_types     { include &quot;complete&quot; };</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">  xkb_compat    { include &quot;complete&quot; };</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">  xkb_symbols   { include &quot;pc+us+ru:2+inet(evdev)&quot; };</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">  xkb_geometry  { include &quot;pc(pc104)&quot; };</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">};</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Запишем всё это в файл, причем будем следовать <a href="http://standards.freedesktop.org/basedir-spec/basedir-spec-latest.html"><span style=" text-decoration: underline; color:#0000ff;">указаниям XDG</span></a>, и положим его в ~/.config/xkb/my.<br /><br />В этом файле нас больше всего интересует строка xkb_symbols, остальное оставим без изменений. Развернём фигурные скобки, и поменяем эту строку на следующее:<br /></p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">xkb_keymap {</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">  xkb_keycodes  { include &quot;evdev+aliases(qwerty)&quot; };</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">  xkb_types     { include &quot;complete&quot; };</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">  xkb_compat    { include &quot;complete&quot; };</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">  xkb_geometry  { include &quot;pc(pc104)&quot; };</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">  xkb_symbols &quot;my&quot; {</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    include &quot;pc+us+ru:2+inet(evdev)&quot;</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    key &lt;AC10&gt; { [ colon, semicolon ] };</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    key &lt;TLDE&gt; { [ asciitilde, grave ] };</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">  };</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">};</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Ну, скрестим пальцы, и загрузим эту конфигурацию:<br /></p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">$ xkbcomp $HOME/.config/xkb/my $DISPLAY</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Пробуем. Если при нажатии клавиши, на которой у вас нарисована буква Ж, печатается символ :, а не ;, а при нажатии на Ё печатается тильда ~, а с Shift'ом всё происходит наоборот, то мы на верном пути.<br /><br />Стоит заметить, что тут же не нужно заморачиваться с Cyrillic_zhe Cyrillic_ZHE, всё работает и так.<br /><br />Идём дальше. Что мы делали? Мы запускали setxkbmap -option с параметром. Давайте посмотрим, что он меняет.<br /></p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">$ setxkbmap -print | grep symbols</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">  xkb_symbols   { include &quot;pc+us+ru:2+inet(evdev)&quot; };</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">$ setxkbmap -option caps:escape</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">$ setxkbmap -print | grep symbols</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">  xkb_symbols   { include &quot;pc+us+ru:2+inet(evdev)+capslock(escape)&quot; };</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Отлично, теперь вроде бы понятно, что меняется раскладка включением каких-то опций.<br />В наш файл my добавим следующую строку в секцию xkb_symbols, сразу после уже существующего include:<br /></p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    include &quot;capslock(escape)&quot;</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Стоит заметить, что точка с запятой после include не нужна, в отличии от точки с запятой в других местах этого конфигурационного файла.<br />Если внимательно посмотреть, то приходит понимание, что вот эти два способа записи идентичны:<br /></p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    include &quot;pc+us+ru:2+inet(evdev)&quot;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    include &quot;capslock(escape)&quot;</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    include &quot;pc+us+ru:2+inet(evdev)+capslock(escape)&quot;</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />При этом первый куда более нагляден.<br /><br />Что же это значит? Мы загружаем нашу раскладку, говорим, что у нас qwerty (xkb_keycodes), что у нас 104 клавиши (xkb_geometry), и переопределяем символы. При этом в разделе символов мы включаем целиком несколько конфигурационных файлов, pc, us, ru. Где они лежат, можно ли на них посмотреть? Естественно, все они лежат в /usr/share/X11/xkb/symbols. Посмотреть их полезно, особенно если вы соберётесь сделать что-то более масштабное, чем мы уже сделали.<br />Хорошо, а где лежат те файлы, которые определяют, что CapsLock и Escape нужно поменять местами? Да там же. Выглядит это примерно вот так:<br /></p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">partial hidden modifier_keys</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">xkb_symbols &quot;swapescape&quot; {</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    key &lt;CAPS&gt; { [ Escape ] };</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    key &lt;ESC&gt;  { [ Caps_Lock ] };</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">};</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">partial hidden modifier_keys</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">xkb_symbols &quot;escape&quot; {</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    key &lt;CAPS&gt; { [ Escape ] };</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">};</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Что такое partial? Это кусок раскладки, который можно включить в другую раскладку. В некоторых конфигурационных файлах щедрые авторы даже добавили комментарии. Но не во всех.<br /><br />Почему мы просто не делаем свой partial, и не включаем его? К стыду своему готов признать, что пытался делать это по описаниям, но у меня не вышло.<br /><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Как это нужно делать в теории</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /><span style=" font-weight:600;">PS</span> Хабраюзер <a href="https://habrahabr.ru/users/kodx/"><span style=" text-decoration: underline; color:#0000ff;">kodx</span></a> выяснил, <a href="http://habrahabr.ru/post/222285/#comment_7586289"><span style=" text-decoration: underline; color:#0000ff;">как это делать правильно</span></a>.<br /><br /></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:large; font-weight:600;">Ягодки</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Не хочу просто Escape на CapsLock. Хочу чтобы Control тоже.<br />Как? Как такое возможно? Пришло время магии.<br /><br />Сначала сделаем так, чтобы при нажатии на CapsLock получался LCTL, добавив вот это в секцию xkb_symbols:<br /></p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    replace key &lt;CAPS&gt; { [ Control_L ] };</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    replace key &lt;LCTL&gt; { [ Caps_Lock ] };</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Вторая строчка нужна для того, чтобы избавиться от вредной привычки нажимать старый левый Ctrl. Можно чуть смягчить это:<br /></p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    replace key &lt;LCTL&gt; { [ VoidSymbol ] };</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Тепепь нам понадобится <span style=" text-decoration: line-through;">глаз дятла</span> утилита <a href="https://github.com/alols/xcape"><span style=" text-decoration: underline; color:#0000ff;">xcape</span></a>, позволяющая назначить модификатору второе действие. Так, что если он нажат в сочетании с какой-то буквенно-циферной клавишей, то он срабатывает как модификатор, а если он нажат и отпущен в одиночку — он срабатывает как-то по-другому, как мы захотим. В бой!<br /></p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">$ xcape -t 1000 -e &quot;Control_L=Escape&quot;</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />xcape демонизируется <span style=" text-decoration: line-through;">под действием глаза дятла</span>. Стоит ещё заметить интересный параметр -t 1000. Нет, он не призывает терминатора, он говорит о том, что если мы таки нажали левый Ctrl, и продержали его нажатым больше 1000 мс, то Escape не сработает. Отличная опция для нерешительных.<br /><br />Из недостатков такого подхода можно назвать то, что Escape будет срабатывать не по нажатию, а по отпусканию клавиши. Кому-то эта задержка не страшна, а кому-то будет критична. А кто-то пойдёт на компромисс.<br /><br /></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:large; font-weight:600;">Бонус</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Для всяких полезных, но редких символов существует такая вещь, как <a href="http://en.wikipedia.org/wiki/Compose_key"><span style=" text-decoration: underline; color:#0000ff;">Compose Key</span></a>, которая позволяет после её нажатия и отпускания набрать некую последовательность, которая соответствует какому-то Unicode символу, который и появится на экране. Например, последовательность нажатий «Compose o o» выдаст символ <span style=" font-weight:600;">°</span>. А «Compose c c c p» выдаст <span style=" font-weight:600;">☭</span>. Забавно? Символов очень много, а сочетания подобраны так, что запонмить их легко, причём в большинстве случаев порядок нажатия не важен, например «Compose e =» и «Compose = e» оба выдают <span style=" font-weight:600;">€</span>. С полным списком стандартных сочетаний можно ознакомиться <a href="http://cgit.freedesktop.org/xorg/lib/libX11/plain/nls/en_US.UTF-8/Compose.pre"><span style=" text-decoration: underline; color:#0000ff;">тут</span></a>, а также можно назначать свои в файле ~/.XCompose.<br />А сделать так, чтобы в качестве Compose работал правый Ctrl можно добавлением следующей строки в наш файл:<br /></p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    include &quot;compose(rctrl)&quot;</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:large; font-weight:600;">В путь-дорогу</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Я сознательно не публикую свой конфиг целиком, чтобы читатель захотел поэкспериментировать. Вот вам пару идей в дорогу:<br />— нажимая клавишу <span style=" font-weight:600;">F</span>, сделайте так, чтобы <span style=" font-weight:600;">HJKL</span> работали как обычные стрелки;<br />— сделайте так, чтобы левая половина клавиатуры сдвигала регистр только с правым Shift, а правая — с левым. Это очень полезно для рук, хотя и не привычно (<a href="http://habrahabr.ru/post/222285/#comment_7581417"><span style=" text-decoration: underline; color:#0000ff;">подсказка</span></a> в комментарии);<br />— сделайте так, чтобы левый Shift не обязательно было зажимать, а чтобы было достаточно его однократно нажать и отпустить, а следом нажать, например, клавишу <span style=" font-weight:600;">5</span>, так, чтобы напечатался символ <span style=" font-weight:600;">%</span> (подсказка: Latch);<br />— повесьте два разных модификатора на одну клавишу<br /><br />Придумывайте, делитесь. Буду рад услышать интересные идеи.<br /><br />PS Если вдруг кто скажет, что потом вот сядешь к кому-нибудь другому за клавиатуру, и сразу всё не так, то скажу так: пересаживаясь из Бентли помочь другу довезти до дома жигули, тоже ругаешься. Тем приятнее садиться обратно в Бентли.<br /><br />Печатайте с удовольствием и берегите себя!</p></body></html>