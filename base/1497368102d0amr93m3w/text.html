<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'Consolas'; font-size:12pt; font-weight:400; font-style:normal;">
<p style=" margin-top:10px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:1.1%;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; font-weight:296; color:#333333;">Выразить строку как число и строку как дату в запросе</span></p>
<p style="-qt-paragraph-type:empty; margin-top:10px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:1.1%; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; font-weight:296; color:#333333;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:10px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:1.1%; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; font-weight:296; color:#333333;"><br /></p>
<p style=" margin-top:20px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;">1. Преобразование таблицы строк в таблицу целых чисел. </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;">Преобразование таблицы строк в таблицу целых чисел позволяет выполнить следующий пакетный запрос. При построении запроса считается, что максимальная длина числа ограничена 17 знаками.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new,courier'; font-size:8.25pt; color:#0000ff;"><br /></span><span style=" font-family:'courier new,courier'; font-size:8.25pt; color:#000000;">    &quot;ВЫБРАТЬ Дано.НомерСтроки, Дано.Строка<br />    |ПОМЕСТИТЬ Дано<br />    |ИЗ &amp;Дано КАК Дано<br />    |;<br />    |ВЫБРАТЬ 0 С,    1 КАК П<br />    |ПОМЕСТИТЬ Р16<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ  1, 10<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ  2, 100<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ  3, 1000<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ  4, 10000<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ  5, 100000<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ  6, 1000000<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ  7, 10000000<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ  8, 100000000<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ  9, 1000000000<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ 10, 10000000000<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ 11, 100000000000<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ 12, 1000000000000<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ 13, 10000000000000<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ 14, 100000000000000<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ 15, 1000000000000000<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ 16, 10000000000000000<br />    |;<br />    |ВЫБРАТЬ СУММА(А.П * Б.С) / МИНИМУМ(А.П) КАК Ответ<br />    |ИЗ Дано, Р16 КАК А, Р16 КАК Б<br />    |ГДЕ    Б.С &lt; 10 И ПОДСТРОКА(Дано.Строка, 17 - А.С, 1) = ПОДСТРОКА(&quot;&quot;0123456789&quot;&quot;, Б.С + 1, 1)<br />    |СГРУППИРОВАТЬ ПО Дано.НомерСтроки&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;">В пакете всего три запроса.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#000000;">Первый запрос пакета выполняет загрузку таблицы значений, содержащей исходные строковые представления чисел, и помещает ее в таблицу «Дано» с колонками «НомерСтроки» и &quot;Строка&quot;. Второй запрос пакета формирует искусственную таблицу, содержащую номера позиций и их вес в десятичной позиционной системе счисления. Счет позиций идет справа налево.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;">Вся основная работа по преобразованию строки в число выполняется в последнем, третьем запросе пакета. В этом запросе таблица «Дано» умножается на таблицу весов позиций Р16 (КАК А) и еще раз на таблицу Р16 (КАК Б). В последней используется только первые десять строк первой колонки  для прохода по номерам всех цифр строки «0123456789». Условие «ГДЕ» отбирает записи, в которых цифры в исходной строке и строке «0123456789» совпадают в позиции, определяемой для исходной строки строкой таблицы весов А и для строки цифр – строкой таблицы номеров цифр Б. Это дает возможность определить искомое число как сумму произведений веса позиции на номер цифры. При этом группировка идет  по строкам таблицы «Дано».</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;">Получающаяся сумма требует нормализации путем деления на минимальный вес позиции, имеющейся в числе. Это делается вместо отсчета позиций от реального правого края строки, который неизвестен в соответствующий момент.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;">Работа данного запроса иллюстрируется схемой на фиг.1, где показано преобразование в число строки «4957379257».</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image17524.png" /><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;"> </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;">Нужно отметить, что данный алгоритм отличается высокой устойчивостью к ошибкам в исходных данных. Например, строка «123абракадабра», строка «абракадабра123», строка «так тоже123можно» одинаково хорошо преобразуются в число 123. Символы, не являющиеся цифрами, заменяются нулями или просто отбрасываются (если они справа от последней цифры) как не распознанные.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;">Преобразования в числа при задании различных исходных строк приведены на скриншотах, прилагаемых к статье. </span></p>
<p style=" margin-top:20px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;">2. Преобразование таблицы строк в таблицу дробных чисел.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;">Преобразование таблицы строк в таблицу дробных чисел можно выполнить следующим пакетным запросом. </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new,courier'; font-size:8.25pt; color:#0000ff;">    </span><span style=" font-family:'courier new,courier'; font-size:8.25pt; color:#000000;">&quot;ВЫБРАТЬ Дано.НомерСтроки, Дано.Строка<br />    |ПОМЕСТИТЬ Дано<br />    |ИЗ &amp;Дано КАК Дано<br />    |;<br />    |ВЫБРАТЬ 0 С,    1 КАК П<br />    |ПОМЕСТИТЬ Р16<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ  1, 10<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ  2, 100<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ  3, 1000<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ  4, 10000<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ  5, 100000<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ  6, 1000000<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ  7, 10000000<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ  8, 100000000<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ  9, 1000000000<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ 10, 10000000000<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ 11, 100000000000<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ 12, 1000000000000<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ 13, 10000000000000<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ 14, 100000000000000<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ 15, 1000000000000000<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ 16, 10000000000000000<br />    |;<br />    |ВЫБРАТЬ СУММА(А.П * Б.С * ВЫБОР КОГДА ПОДСТРОКА(Строка, 1, 17 - А.С) ПОДОБНО &quot;&quot;%.%&quot;&quot; ТОГДА 10 ИНАЧЕ 1 КОНЕЦ)<br />    |/ МИНИМУМ(ВЫБОР КОГДА НЕ ПОДСТРОКА(Строка, 1, 17 - А.С) ПОДОБНО &quot;&quot;%.%&quot;&quot; ТОГДА А.П ИНАЧЕ 100000000000000000 КОНЕЦ) КАК Ответ<br />    |ИЗ Дано КАК Дано, Р16 КАК А, Р16 КАК Б<br />    |ГДЕ    Б.С &lt; 10 И ПОДСТРОКА(Строка, 17 - А.С, 1) = ПОДСТРОКА(&quot;&quot;0123456789&quot;&quot;, Б.С + 1, 1)<br />    |СГРУППИРОВАТЬ ПО Дано.НомерСтроки&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new,courier'; font-size:8.25pt; color:#000000;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#000000;">Данный пакетный запрос отличается от предыдущего особой обработкой позиций, находящихся справа от первой десятичной точки. Такие позиции выделяются с использованием оператора ПОДОБНО. Проверяется подобие подстроки, заканчивающейся в данной позиции и шаблона &quot;%.%&quot;. Для позиций, находящихся правее точки, применяется дополнительный множитель 10. Также меняется определение нормализующего делителя, который находится как минимум веса позиций, не находящихся правее первой точки.</span></p>
<p style=" margin-top:20px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#000000;">3. Преобразование таблицы строк в таблицу целых чисел с &quot;выращиванием&quot; таблицы весов.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#000000;">В данном варианте первого запроса вместо громоздкого текста, который непосредственно определяет строки таблицы весов, используется прием выращивания (порождения) этой таблицы.<br /></span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new,courier'; font-size:8.25pt; color:#0000ff;"><br />    </span><span style=" font-family:'courier new,courier'; font-size:8.25pt; color:#000000;">&quot;ВЫБРАТЬ Дано.НомерСтроки, Дано.Строка<br />    |ПОМЕСТИТЬ Дано<br />    |ИЗ &amp;Дано КАК Дано<br />    |;<br />    |ВЫБРАТЬ 0 КАК С, 1 КАК П<br />    |ПОМЕСТИТЬ Р1<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ 1, 10<br />    |;<br />    |ВЫБРАТЬ    А.С + Б.С КАК С, МАКСИМУМ(А.П * Б.П) КАК П<br />    |ПОМЕСТИТЬ Р2<br />    |ИЗ Р1 КАК А, Р1 КАК Б<br />    |СГРУППИРОВАТЬ ПО А.С + Б.С<br />    |;<br />    |ВЫБРАТЬ    А.С + Б.С КАК С, МАКСИМУМ(А.П * Б.П) КАК П<br />    |ПОМЕСТИТЬ Р4<br />    |ИЗ Р2 КАК А, Р2 КАК Б<br />    |СГРУППИРОВАТЬ ПО А.С + Б.С<br />    |;<br />    |ВЫБРАТЬ    А.С + Б.С КАК С, МАКСИМУМ(А.П * Б.П) КАК П<br />    |ПОМЕСТИТЬ Р8<br />    |ИЗ Р4 КАК А, Р4 КАК Б<br />    |СГРУППИРОВАТЬ ПО А.С + Б.С<br />    |;<br />    |ВЫБРАТЬ    А.С + Б.С КАК С, МАКСИМУМ(А.П * Б.П) КАК П<br />    |ПОМЕСТИТЬ Р16<br />    |ИЗ Р8 КАК А, Р8 КАК Б<br />    |СГРУППИРОВАТЬ ПО А.С + Б.С<br />    |;<br />    |ВЫБРАТЬ СУММА(А.П * Б.С) / МИНИМУМ(А.П) КАК Ответ<br />    |ИЗ Дано, Р16 КАК А, Р16 КАК Б<br />    |ГДЕ    Б.С &lt; 10 И ПОДСТРОКА(Дано.Строка, 17 - А.С, 1) = ПОДСТРОКА(&quot;&quot;0123456789&quot;&quot;, Б.С + 1, 1)<br />    |СГРУППИРОВАТЬ ПО Дано.НомерСтроки&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new,courier'; font-size:8.25pt; color:#0000ff;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;">В этом пакетном запросе семь подзапросов.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;">Первый запрос, как всегда, осуществляет ввод данных.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;">Во втором запросе пакета определяется таблица Р1 для позиций 0 и 1 с весом 1 и 10. Затем в третьем запросе перемножением Р1 на себя получается таблица Р2, содержащая позиции 0, 1 и 2 с весом 1, 10 и 100. В четвертом запросе перемножением Р2 на себя получается  таблица Р4. Схема этого умножения показана на фиг.2. В пятом запросе пакета Р4 умножается на себя и получается Р8, в шестом Р8 умножается на себя и получается Р16. При перемножении используется группировка по сумме номера позиции с агрегацией в виде максимума произведения весов позиций. Поскольку число позиций каждый раз увеличивается вдвое,  для выращивания итоговой таблицы из 17 строк понадобилось всего четыре запроса. Похожая «математика» используется в статье &quot;Транзитивное замыкание запросом&quot; [</span><a href="http://infostart.ru/public/158512/"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; text-decoration: underline; color:#428bca;">http://infostart.ru/public/158512/</span></a><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;">]. Все получаемые таблицы изображены на фиг.3.</span></p>
<p style=" margin-top:20px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image23237.png" /></p>
<p style=" margin-top:20px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image20330.png" /></p>
<p style=" margin-top:20px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;">4. Преобразование таблицы строк в таблицу дат. </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;">Преобразование таблицы строк вида «ГГГГММДД» в таблицу дат можно выполнить следующим пакетным запросом.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new,courier'; font-size:8.25pt; color:#0000ff;">    </span><span style=" font-family:'courier new,courier'; font-size:8.25pt; color:#000000;">&quot;ВЫБРАТЬ Дано.НомерСтроки, Дано.Строка</span><span style=" font-family:'courier new,courier'; font-size:8.25pt; color:#0000ff;"><br /></span><span style=" font-family:'courier new,courier'; font-size:8.25pt; color:#000000;">    |ПОМЕСТИТЬ Дано<br />    |ИЗ &amp;Дано КАК Дано<br />    |;<br />    |ВЫБРАТЬ 0 Х, 0 Д, 0 М, 1000 Г<br />    |ПОМЕСТИТЬ Формат<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ 1, 0, 0, 100<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ 2, 0, 0, 10<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ 3, 0, 0, 1<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ 4, 0, 10, 0<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ 5, 0, 1, 0<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ 6, 10, 0, 0<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ 7, 1, 0, 0<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ 8, 0, 0, 0<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ 9, 0, 0, 0<br />    |;<br />    |ВЫБРАТЬ ДОБАВИТЬКДАТЕ(ДОБАВИТЬКДАТЕ(ДОБАВИТЬКДАТЕ(ДАТАВРЕМЯ(1,1,1,0,0,0),ДЕНЬ,СУММА(А.Д*Б.Х)-1),МЕСЯЦ,СУММА(А.М*Б.Х)-1),ГОД,СУММА(А.Г*Б.Х)-1) КАК Ответ<br />    |ИЗ Дано, Формат КАК А, Формат КАК Б<br />    |ГДЕ    А.Х &lt; 8 И Б.Х &lt; 10 И ПОДСТРОКА(Дано.Строка, А.Х + 1, 1) = ПОДСТРОКА(&quot;&quot;0123456789&quot;&quot;, Б.Х + 1, 1)<br />    |СГРУППИРОВАТЬ ПО Дано.НомерСтроки&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new,courier'; font-size:8.25pt; color:#0000ff;"> </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new,courier'; font-size:8.25pt; color:#0000ff;"> </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;">В данном запросе всего три подзапроса, причем первый из них выполняет функцию ввода таблицы строк в запрос.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;">Во втором запросе определяется временная таблица &quot;Формат&quot; с четырьмя колонками. В колонке &quot;Х&quot; записывается номер позиции в строке, начиная с нуля слева направо, в колонке &quot;Д&quot; - вес позиции при подсчете числа дней, &quot;М&quot; - месяцев, &quot;Г&quot; - лет. В последнем запросе вычисляется сумма произведений каждой колонки на номер цифры, находящейся в соответствующей позиции. Далее эти суммы произведений как число лет, месяцев и дней добавляются функцией добавить к дате сначала к &quot;нулевому дню&quot; '00010101', потом к результату первого добавления, а затем к результату второго. Это и дает в итоге искомую дату.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;">Очевидно, что переопределением таблицы &quot;Формат&quot; можно легко настроить запрос на нужный формат читаемых дат. Кроме того, нетрудно учесть наличие в строке значений часов, минут и секунд для ввода даты со временем. </span></p>
<p style=" margin-top:20px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new,courier'; font-size:8.25pt; color:#0000ff;"> </span></p>
<p style=" margin-top:20px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;">5. Преобразование таблицы строк в таблицу дат с &quot;выращиванием&quot; таблицы позиций.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;">Текст данного запроса выглядит следующим образом. </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new,courier'; font-size:8.25pt; color:#0000ff;"><br />    </span><span style=" font-family:'courier new,courier'; font-size:8.25pt; color:#000000;">&quot;ВЫБРАТЬ Дано.НомерСтроки, Дано.Строка<br />    |ПОМЕСТИТЬ Дано<br />    |ИЗ &amp;Дано КАК Дано<br />    |;<br />    |ВЫБРАТЬ    0 КАК Х<br />    |ПОМЕСТИТЬ Р1<br />    |ОБЪЕДИНИТЬ ВЫБРАТЬ 1<br />    |;<br />    |ВЫБРАТЬ    А.Х + 2 * Б.Х КАК Х<br />    |ПОМЕСТИТЬ Р2<br />    |ИЗ Р1 КАК А, Р1 КАК Б<br />    |;<br />    |ВЫБРАТЬ    А.Х + 4 * Б.Х КАК Х<br />    |ПОМЕСТИТЬ Р4<br />    |ИЗ Р2 КАК А, Р2 КАК Б<br />    |;<br />    |ВЫБРАТЬ ДОБАВИТЬКДАТЕ(<br />    |           ДОБАВИТЬКДАТЕ(<br />    |               ДОБАВИТЬКДАТЕ(<br />    |                   ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)<br />    |                   , ДЕНЬ<br />    |                   , СУММА(ВЫБОР А.Х КОГДА 7 ТОГДА 1 КОГДА 6 ТОГДА 10 КОНЕЦ * Б.Х) - 1<br />    |               )<br />    |               , МЕСЯЦ<br />    |               , СУММА(ВЫБОР А.Х КОГДА 5 ТОГДА 1 КОГДА 4 ТОГДА 10 КОНЕЦ * Б.Х) - 1<br />    |           )<br />    |           , ГОД<br />    |           , СУММА(ВЫБОР А.Х КОГДА 3 ТОГДА 1 КОГДА 2 ТОГДА 10 КОГДА 1 ТОГДА 100 КОГДА 0 ТОГДА 1000 КОНЕЦ * Б.Х) - 1<br />    |       ) КАК Ответ<br />    |ИЗ Дано, Р4 КАК А, Р4 КАК Б<br />    |ГДЕ    А.Х &lt; 8 И Б.Х &lt; 10 И ПОДСТРОКА(Дано.Строка, А.Х + 1, 1) = ПОДСТРОКА(&quot;&quot;0123456789&quot;&quot;, Б.Х + 1, 1)<br />    |СГРУППИРОВАТЬ ПО Дано.НомерСтроки&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;">В отличие от предыдущих запросов, здесь не используется определение веса позиций заранее. Веса позиций определяются в ходе суммирования. Поэтому заранее достаточно вырастить таблицу позиций цифр Р16. Это делается также как в статье &quot;Порождающий запрос&quot; [</span><a href="http://infostart.ru/public/90367/"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; text-decoration: underline; color:#428bca;">http://infostart.ru/public/90367/</span></a><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;">] из таблицы Р2, содержащей 0 и 1, задаваемой вторым запросом пакета. Сначала Р2 умножается на себя и без группировок получается Р4 из четырех строк 0, 1, 2 и 3 (третий запрос), затем Р4 умножается на себя и получается Р16 из 16-ти строк 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14 и 15 (четвертый запрос пакета). Умножение матрицы Р4 на себя в четвертом запросе показано в виде схемы фиг.4.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image4256.png" /></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;">Вся основная работа выполняется в пятом запросе. Год в виде числа, месяц в виде числа и день в виде числа получаются как сумма произведений номера цифры на вес позиции. Вес позиций определяется для каждого элемента даты отдельно при помощи оператора «ВЫБОР». Определенные год, месяц и день подставляются в функции «ДОБАВИТЬКДАТЕ», что и дает в итоге искомую дату.</span></p>
<p style=" margin-top:20px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;">6. Преобразование таблицы строк в таблицу дат со временем по формату, задаваемом параметром запроса. </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;">При анализе запроса 4 можно увидеть, что формат даты задается таблицей весов позиций года, месяца и дня «Формат». Эту таблицу можно дополнить колонками для часов, минут и секунд. При различном заполнении этой таблицы можно анализировать даты, представленные в самом различном формате. Примеры заполнения таблицы &quot;Формат&quot; для различных форматов даты приведены на фиг.5.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image23995.png" /><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;"> </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; font-weight:696; color:#333333;">В связи с эти возникает идея: А если вообще не задавать таблицу &quot;Формат&quot; заранее, а построить ее внутри запроса путем анализа текстового параметра &quot;&amp;Формат&quot;, передаваемого в запрос и определяющего формат даты</span><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;">. Тогда запрос станет чрезвычайно гибким и универсальным. На этой идее построен шестой запрос.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;">Текст данного запроса, отличающейся универсальностью за счет управления преобразованием с помощью строкового параметра &quot;&amp;Формат&quot;, можно посмотреть в прилагаемой к статье обработке. Дополнительным бонусом, скачавшим обработку, будут примеры очень уместного использования (как кажется) функции &quot;НовыйЗапрос&quot; [</span><a href="http://infostart.ru/public/163853/"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; text-decoration: underline; color:#428bca;">http://infostart.ru/public/163853/</span></a><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;">] в модуле обработки. На скриншотах, прилагаемых к статье,  приведены примеры преобразований при задании различных форматов даты. В определении формата использованы русские букы &quot;Г&quot;, &quot;М&quot;, &quot;Д&quot;, &quot;Ч&quot;, &quot;Н&quot; и &quot;С&quot;. Важно, что позиции минут обозначены не маленькой русской &quot;м&quot;, а русской &quot;н&quot;, поскольку в запросе нет возможности различить регистр символов. Для заполнения незначащих позиций можно использовать любые другие символы. Примеры задания формата: &quot;ГГГГММДДЧЧННСС&quot;, &quot;ДД_ММ_ГГГГ_ЧЧ:НН:СС&quot;, &quot;ССССС - тоже работает&quot;. </span></p>
<p style=" margin-top:20px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;">Заключение.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;"> </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;">В заключение хочется отметить, что хотя язык запросов платформы 1С:Предприятие имеет весьма слабые возможности работы со строками, использование техники искусственых таблиц отчасти компенсирует этот недостаток. С другой стороны, та же причина открывает широкий простор нашей изобретательности при написании запросов. Пользуйтесь этим!</span></p>
<p style=" margin-top:20px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; font-weight:296; color:#333333;">Скриншоты</span></p>
<p style=" margin-top:15px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image14751.png" /><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;"><br />Результаты преобразования в окне тестовой обработки</span></p>
<p style=" margin-top:15px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image15369.png" /><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;"><br />Результаты преобразования в окне тестовой обработки</span></p>
<p style=" margin-top:15px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image4992.png" /><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:8.25pt; color:#333333;"><br />Результаты преобразования в окне тестовой обработки</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /></p></body></html>