<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'Courier New'; font-size:12pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-weight:600; color:#333333; background-color:#ffffff;">Чем будет для Вас полезна эта статья:</span><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-weight:600; color:#333333;"><br /><br />• Вы изучите варианты ускорения операций обработки данных<br />• Научитесь запускать в «1С:Предприятие 8» несколько потоков<br />• Узнаете об ограничениях многопоточного режима в 1С</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; color:#333333;"> </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; color:#333333;">Периодически возникает необходимость в ускорении некоторых участков кода, в которых при беглом ознакомлении нет потенциала для ускорения.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; color:#333333;">Рассмотрим в качестве примера выгрузку и/или загрузку большого количества данных.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; color:#333333;">В данном случае «планкой производительности» зачастую выступает непосредственно производительность аппаратных средств. При этом сами процедуры загрузки-выгрузки выполняются достаточно длительное время, часто измеряемое в часах.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; color:#333333;">Не все знают, что в платформе «1С: Предприятие 8» </span><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-weight:696; color:#333333;">часть операций можно выполнять параллельно</span><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; color:#333333;">, путем одновременного выполнения в несколько потоков.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-weight:696; color:#333333;">Такая многопоточная обработка вполне применима в случае, когда нужно обработать независимые блоки данных.</span><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; color:#333333;"> В частности, создать большой объем элементов данных, осуществить проведение документов, не пересекающихся по значениям набора измерений, сделать массовое обновление элементов справочников, выполнить загрузку данных в регистры и т.д. Для примера рассмотрим задачу: необходимо провести обновление реквизита «Цена» для всех элементов справочника «Товары». Количество элементов справочника «Товары» равно </span><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-weight:696; color:#333333;">100 000</span><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; color:#333333;">. Самым простым и очевидным решением выступает нижеприведенный код обработки, который быстро пишется, но при этом очень долго работает: </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; color:#333333;"> </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f5f5f5;"><span style=" font-size:9pt; color:#993300;">&amp;НаСервере </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#ff0000;">Процедура </span><span style=" font-size:9pt; color:#0000ff;">ОбновитьЦену</span><span style=" font-size:9pt; color:#ff0000;">()</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#0000ff;">ВремяНачала </span><span style=" font-size:9pt; color:#ff0000;">= </span><span style=" font-size:9pt; color:#0000ff;">ТекущаяДата</span><span style=" font-size:9pt; color:#ff0000;">();</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#000000;"><br /> </span><span style=" font-size:9pt; color:#0000ff;">Запрос</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#ff0000;">= Новый </span><span style=" font-size:9pt; color:#0000ff;">Запрос</span><span style=" font-size:9pt; color:#ff0000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#0000ff;">Запрос.Текст </span><span style=" font-size:9pt; color:#ff0000;">= </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#000000;">&quot;ВЫБРАТЬ </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#000000;">| Товары.Ссылка </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#000000;">|ИЗ </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#000000;">| Справочник.Товары КАК Товары&quot;</span><span style=" font-size:9pt; color:#ff0000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#000000;"><br /> </span><span style=" font-size:9pt; color:#0000ff;">ТаблицаТоваров</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#ff0000;">= </span><span style=" font-size:9pt; color:#0000ff;">Запрос.Выполнить</span><span style=" font-size:9pt; color:#ff0000;">()</span><span style=" font-size:9pt; color:#0000ff;">.Выгрузить</span><span style=" font-size:9pt; color:#ff0000;">();</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#000000;"><br /> </span><span style=" font-size:9pt; color:#0000ff;">Наценка</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#ff0000;">= </span><span style=" font-size:9pt; color:#000000;">1.10;</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#000000;"><br /></span><span style=" font-size:9pt; color:#ff0000;">Для каждого </span><span style=" font-size:9pt; color:#0000ff;">ТекСторока</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#ff0000;">Из</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#0000ff;">ТаблицаТоваров</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#ff0000;">Цикл</span><span style=" font-size:9pt; color:#000000;"> </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#0000ff;"> ТоварОбъект</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#ff0000;">=</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#0000ff;">ТекСторока.Ссылка.ПолучитьОбъект</span><span style=" font-size:9pt; color:#ff0000;">();</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#0000ff;"> ТоварОбъект.Цена </span><span style=" font-size:9pt; color:#ff0000;">=</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#0000ff;">ТоварОбъект</span><span style=" font-size:9pt; color:#000000;">.</span><span style=" font-size:9pt; color:#0000ff;">Цена</span><span style=" font-size:9pt; color:#ff0000;">*</span><span style=" font-size:9pt; color:#0000ff;">Наценка</span><span style=" font-size:9pt; color:#ff0000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#0000ff;"> ТоварОбъект.Записать</span><span style=" font-size:9pt; color:#ff0000;">();</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#ff0000;">КонецЦикла;</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#000000;"><br /> </span><span style=" font-size:9pt; color:#0000ff;">Длительность</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#ff0000;">=</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#0000ff;">ТекущаяДата</span><span style=" font-size:9pt; color:#ff0000;">()-</span><span style=" font-size:9pt; color:#0000ff;">ВремяНачала</span><span style=" font-size:9pt; color:#ff0000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#000000;"><br /> </span><span style=" font-size:9pt; color:#0000ff;">Сообщить</span><span style=" font-size:9pt; color:#000000;">(&quot;Длительность: &quot; </span><span style=" font-size:9pt; color:#ff0000;">+ </span><span style=" font-size:9pt; color:#0000ff;">Длительность</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#ff0000;">+ </span><span style=" font-size:9pt; color:#000000;">&quot; сек.&quot;</span><span style=" font-size:9pt; color:#ff0000;">);</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#000000;"><br /> </span><span style=" font-size:9pt; color:#ff0000;">КонецПроцедуры</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; color:#333333;"> </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; color:#333333;">В нашем случае обработка выполнялась </span><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-weight:696; color:#333333;">1 187 секунд или 19,7 минуты</span><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; color:#333333;">. Теперь воспользуемся многопоточным выполнением программного кода. Перепишем код обработки следующим образом: </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; color:#333333;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f5f5f5;"><span style=" font-size:9pt; color:#993300;">&amp;НаСервере </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#ff0000;">Процедура </span><span style=" font-size:9pt; color:#0000ff;">ОбновитьЦену</span><span style=" font-size:9pt; color:#ff0000;">()</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#000000;"> <br /> </span><span style=" font-size:9pt; color:#0000ff;">ВремяНачала</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#ff0000;">=</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#0000ff;">ТекущаяДата</span><span style=" font-size:9pt; color:#ff0000;">();</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#000000;"> <br /> </span><span style=" font-size:9pt; color:#0000ff;">Запрос</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#ff0000;">= Новый </span><span style=" font-size:9pt; color:#0000ff;">Запрос</span><span style=" font-size:9pt; color:#ff0000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#0000ff;"> Запрос.Текст </span><span style=" font-size:9pt; color:#ff0000;">= </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#000000;"> &quot;ВЫБРАТЬ </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#000000;"> | Товары.Ссылка </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#000000;"> |ИЗ </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#000000;"> | Справочник.Товары КАК Товары&quot;</span><span style=" font-size:9pt; color:#ff0000;">;</span><span style=" font-size:9pt; color:#000000;"> <br /> </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#0000ff;"> ТаблицаТоваров</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#ff0000;">= </span><span style=" font-size:9pt; color:#0000ff;">Запрос.Выполнить</span><span style=" font-size:9pt; color:#ff0000;">().</span><span style=" font-size:9pt; color:#0000ff;">Выгрузить</span><span style=" font-size:9pt; color:#ff0000;">();</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#000000;"><br /> </span><span style=" font-size:9pt; color:#339966;">// определяем максимальное количество потоков </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#0000ff;"> ЧислоПотоков</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#ff0000;">=</span><span style=" font-size:9pt; color:#000000;"> 8</span><span style=" font-size:9pt; color:#ff0000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#000000;"><br /> </span><span style=" font-size:9pt; color:#0000ff;">ЧислоСтрокВТаблице</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#ff0000;">=</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#0000ff;">ТаблицаТоваров.Количество</span><span style=" font-size:9pt; color:#ff0000;">();</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#000000;"><br /> </span><span style=" font-size:9pt; color:#339966;">// объем порции данных для обработки каждым потоком</span><span style=" font-size:9pt; color:#000000;"> </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#0000ff;"> РазмерПорции</span><span style=" font-size:9pt; color:#000000;"> = </span><span style=" font-size:9pt; color:#0000ff;">Цел</span><span style=" font-size:9pt; color:#ff0000;">(</span><span style=" font-size:9pt; color:#0000ff;">ЧислоСтрокаВТаблице/ЧислоПотоков</span><span style=" font-size:9pt; color:#ff0000;">)</span><span style=" font-size:9pt; color:#000000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#000000;"><br /> </span><span style=" font-size:9pt; color:#339966;">// массив, где будут храниться фоновые задания</span><span style=" font-size:9pt; color:#000000;"> </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#0000ff;"> МассивЗаданий</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#ff0000;">=</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#0000ff;">НовыйМассив</span><span style=" font-size:9pt; color:#ff0000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#000000;"><br /> </span><span style=" font-size:9pt; color:#ff0000;">Для</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#0000ff;">НомерПотока</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#ff0000;">=</span><span style=" font-size:9pt; color:#000000;"> 1 </span><span style=" font-size:9pt; color:#ff0000;">По</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#0000ff;">ЧислоПотоков</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#ff0000;">Цикл</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#000000;"><br /> </span><span style=" font-size:9pt; color:#339966;">// определяем индекс для начала обработки данных данным потоком </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#339966;">// разные потоки обрабатывают разные части таблицы</span><span style=" font-size:9pt; color:#000000;"> </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#0000ff;"> ИндексНачала</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#ff0000;">=</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#ff0000;">(</span><span style=" font-size:9pt; color:#0000ff;">НомерПотока</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#ff0000;">-</span><span style=" font-size:9pt; color:#000000;"> 1</span><span style=" font-size:9pt; color:#ff0000;">)*</span><span style=" font-size:9pt; color:#0000ff;">РазмерПорции</span><span style=" font-size:9pt; color:#ff0000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#000000;"><br /> </span><span style=" font-size:9pt; color:#0000ff;">Если</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#ff0000;">(</span><span style=" font-size:9pt; color:#0000ff;">НомерПотока</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#ff0000;">=</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#0000ff;">ЧислоПотоков</span><span style=" font-size:9pt; color:#ff0000;">) Тогда</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#339966;"> // если это последний поток, то он обрабатывает все оставшиеся данные </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#339966;">// т.к. число потоков может не быть кратно количеству строк в таблице</span><span style=" font-size:9pt; color:#000000;"> </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#0000ff;"> РазмерПорции</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#ff0000;">= </span><span style=" font-size:9pt; color:#0000ff;">ЧислоСтрокВТаблице</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#ff0000;">-(</span><span style=" font-size:9pt; color:#0000ff;">ЧислоПотоков</span><span style=" font-size:9pt; color:#000000;">*</span><span style=" font-size:9pt; color:#0000ff;">РазмерПорции</span><span style=" font-size:9pt; color:#ff0000;">)+</span><span style=" font-size:9pt; color:#0000ff;">РазмерПорции</span><span style=" font-size:9pt; color:#ff0000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#ff0000;"> КонецЕсли;</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#000000;"><br /> </span><span style=" font-size:9pt; color:#339966;">// определяем массив параметров для процедуры</span><span style=" font-size:9pt; color:#000000;"> </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#0000ff;"> НаборПараметров </span><span style=" font-size:9pt; color:#ff0000;">=</span><span style=" font-size:9pt; color:#0000ff;"> </span><span style=" font-size:9pt; color:#ff0000;">Новый</span><span style=" font-size:9pt; color:#0000ff;"> Массив</span><span style=" font-size:9pt; color:#ff0000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#0000ff;"> НаборПараметров.Добавить</span><span style=" font-size:9pt; color:#ff0000;">(</span><span style=" font-size:9pt; color:#0000ff;">ТаблицаТоваров</span><span style=" font-size:9pt; color:#ff0000;">);</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#0000ff;"> НаборПараметров.Добавить</span><span style=" font-size:9pt; color:#ff0000;">(</span><span style=" font-size:9pt; color:#0000ff;">ИндексНачала</span><span style=" font-size:9pt; color:#ff0000;">);</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#0000ff;"> НаборПараметров.Добавить</span><span style=" font-size:9pt; color:#ff0000;">(</span><span style=" font-size:9pt; color:#0000ff;">РазмерПорции</span><span style=" font-size:9pt; color:#ff0000;">);</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#000000;"><br /> </span><span style=" font-size:9pt; color:#008000;">// запуск фонового задания</span><span style=" font-size:9pt; color:#339966;"> </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#0000ff;"> Задание </span><span style=" font-size:9pt; color:#ff0000;">=</span><span style=" font-size:9pt; color:#0000ff;"> ФоновыеЗадания.Выполнить</span><span style=" font-size:9pt; color:#ff0000;">(</span><span style=" font-size:9pt; color:#000000;">&quot;ОбщийМодуль1.ОбновитьЦенуТовара&quot;</span><span style=" font-size:9pt; color:#0000ff;">, НаборПараметров</span><span style=" font-size:9pt; color:#ff0000;">);</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#000000;"><br /> </span><span style=" font-size:9pt; color:#008000;">// добавляем задание в массив, чтобы потом отследить выполнение</span><span style=" font-size:9pt; color:#000000;"> </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#0000ff;"> МассивЗаданий.Добавить</span><span style=" font-size:9pt; color:#ff0000;">(</span><span style=" font-size:9pt; color:#0000ff;">Задание</span><span style=" font-size:9pt; color:#ff0000;">);</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#000000;"><br /> </span><span style=" font-size:9pt; color:#ff0000;">КонецЦикла;</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#000000;"><br /> </span><span style=" font-size:9pt; color:#339966;">// проверим результат выполнения фоновых заданий</span><span style=" font-size:9pt; color:#000000;"> </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#ff0000;">Если</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#0000ff;">МассивЗаданий.Количество</span><span style=" font-size:9pt; color:#ff0000;">() &gt; </span><span style=" font-size:9pt; color:#000000;">0 </span><span style=" font-size:9pt; color:#ff0000;">Тогда</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#ff0000;"> Попытка</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#0000ff;"> ФоновыеЗадания.ОжидатьЗавершения</span><span style=" font-size:9pt; color:#ff0000;">(</span><span style=" font-size:9pt; color:#0000ff;">МассивЗаданий</span><span style=" font-size:9pt; color:#ff0000;">);</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#ff0000;">Исключение</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#008000;">// действия в случае ошибки </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#ff0000;"> КонецПопытки;</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#ff0000;">КонецЕсли;</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#000000;"><br /> </span><span style=" font-size:9pt; color:#0000ff;">Длительность</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#ff0000;">=</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#0000ff;">ТекущаяДата</span><span style=" font-size:9pt; color:#ff0000;">()-</span><span style=" font-size:9pt; color:#0000ff;">ВремяНачала</span><span style=" font-size:9pt; color:#ff0000;">;</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#000000;"><br /> </span><span style=" font-size:9pt; color:#0000ff;">Сообщить</span><span style=" font-size:9pt; color:#ff0000;">(</span><span style=" font-size:9pt; color:#000000;">&quot;Длительность: &quot; </span><span style=" font-size:9pt; color:#ff0000;">+</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#0000ff;">Длительность</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#ff0000;">+</span><span style=" font-size:9pt; color:#000000;"> &quot;сек.&quot;</span><span style=" font-size:9pt; color:#ff0000;">);</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#000000;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#ff0000;">КонецПроцедуры</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; color:#333333;"> </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f5f5f5;"><span style=" font-size:9pt; color:#ff0000;">Процедура</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#0000ff;">ОбновитьЦенуТовара</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#ff0000;">(</span><span style=" font-size:9pt; color:#0000ff;">ТаблицаТоваров</span><span style=" font-size:9pt; color:#ff0000;">,</span><span style=" font-size:9pt; color:#0000ff;">ИндексНачала</span><span style=" font-size:9pt; color:#ff0000;">,</span><span style=" font-size:9pt; color:#0000ff;">РазмерПорции</span><span style=" font-size:9pt; color:#ff0000;">) Экспорт</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#000000;"><br /> </span><span style=" font-size:9pt; color:#0000ff;">Наценка</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#ff0000;">=</span><span style=" font-size:9pt; color:#000000;"> 1.10</span><span style=" font-size:9pt; color:#ff0000;">; </span><span style=" font-size:9pt; color:#008000;">// наценка 10% </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#000000;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#008000;">// обновляем цену только для определенной части таблицы</span><span style=" font-size:9pt; color:#000000;"> </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#ff0000;">Для</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#0000ff;">Сч</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#ff0000;">=</span><span style=" font-size:9pt; color:#000000;"> 1 </span><span style=" font-size:9pt; color:#ff0000;">По</span><span style=" font-size:9pt; color:#000000;"> </span><span style=" font-size:9pt; color:#0000ff;">РазмерПорции</span><span style=" font-size:9pt; color:#ff0000;">Цикл</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#ff0000;">Индекс </span><span style=" font-size:9pt; color:#000000;">= ?(Сч</span><span style=" font-size:9pt; color:#ff0000;">=</span><span style=" font-size:9pt; color:#000000;">1</span><span style=" font-size:9pt; color:#ff0000;">,</span><span style=" font-size:9pt; color:#0000ff;">ИндексНачала</span><span style=" font-size:9pt; color:#ff0000;">,</span><span style=" font-size:9pt; color:#0000ff;">Индекс</span><span style=" font-size:9pt; color:#ff0000;">+</span><span style=" font-size:9pt; color:#000000;">1);</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#0000ff;">ТоварОбъект </span><span style=" font-size:9pt; color:#ff0000;">= </span><span style=" font-size:9pt; color:#0000ff;">ТаблицаТоваров</span><span style=" font-size:9pt; color:#ff0000;">[</span><span style=" font-size:9pt; color:#0000ff;">Индекс</span><span style=" font-size:9pt; color:#ff0000;">]</span><span style=" font-size:9pt; color:#0000ff;">.Ссылка.ПолучитьОбъект</span><span style=" font-size:9pt; color:#ff0000;">();</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#0000ff;"> ТоварОбъект.Цена </span><span style=" font-size:9pt; color:#ff0000;">=</span><span style=" font-size:9pt; color:#0000ff;"> ТоварОбъект.Цена </span><span style=" font-size:9pt; color:#ff0000;">* </span><span style=" font-size:9pt; color:#0000ff;">Наценка;</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#0000ff;"> ТоварОбъект.Записать</span><span style=" font-size:9pt; color:#ff0000;">();</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#ff0000;"> КонецЦикла;</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:9pt; color:#ff0000;">КонецПроцедуры</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; color:#333333;"> </span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; color:#333333;">В нашем случае использовалось восемь потоков, обновление цен было выполнено за </span><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-weight:696; color:#333333;">859 секунд или 14,3 минуты</span><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; color:#333333;">.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; color:#333333;">То есть обработка одной и той же Таблицы Значений параллельно разными потоками приводит к выигрышу в скорости.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; color:#333333;">Код выполнялся на виртуальной машине с одним процессором без RAID массивов. На реальном и хорошем «железе» выигрыш в скорости будет существенно больше.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; color:#333333;">Заметим, что данную задачу можно решить по-другому, мы привели лишь один пример реализации.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-weight:696; color:#333333;">Важно! Не нужно устанавливать слишком большое количество потоков, так как большого прироста скорости вы от этого все равно не получите, а стабильность работы может нарушиться.</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; color:#333333;">Наилучшим будет использование 8-10 потоков, а их оптимальное количество можно определить экспериментально. Попробуйте самостоятельно провести эксперимент, база и обработки в приложении к статье.</span></p></body></html>